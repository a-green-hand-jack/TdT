<!--
这个文档由 Claude-3.5-Sonnet 模型生成，用于记录 TDT 酶专利序列提取项目中 PDF 解析功能的详细设计、讨论和实现过程。

---
优化后的 Prompt:
作为一名经验丰富、代码风格严谨的 Python 技术专家和架构师，请为 TDT 酶专利序列提取项目设计并实现一个轻量化的 PDF 解析功能。该功能需要满足以下详细要求：

1. **输入处理**：解析专利 PDF 文件，重点关注文本内容和少量数学公式，忽略图片内容
2. **核心功能**：精确提取《权利要求书》章节，通过页眉章节说明进行识别
3. **输出格式**：生成便于 LLM 处理的结构化文本，保持原文件名
4. **技术栈**：使用 uv 进行包管理，最终提供命令行工具接口
5. **项目结构**：遵循 src 布局，采用模块化设计
6. **文档要求**：详细记录技术选择、实现过程和测试结果

请确保实现轻量化、高效且易于维护的解决方案。
---
-->

# PDF 解析功能讨论与实现

本文档记录了 TDT 酶专利序列提取项目中 PDF 解析功能的设计讨论和实现过程。

## 目录

- [需求分析](#需求分析)
- [技术方案讨论](#技术方案讨论)
- [实现计划](#实现计划)
- [任务清单](#任务清单)
- [执行记录](#执行记录)

## 需求分析

### 输入

- **输入文件**：专利 PDF 文件
- **输入路径**：`Patents/` 文件夹下的 PDF 文件

### 输出

- **目标内容**：PDF 文件中的《权利要求书》部分
- **识别方法**：通过页眉中的章节说明识别该部分
- **内容范围**：专注于文本内容和少量数学公式，忽略图片
- **输出格式**：便于 LLM 读取的结构化文本格式
- **输出位置**：指定的输出文件夹
- **文件命名**：保持与原 PDF 文件相同的文件名
- **交付形式**：命令行工具，支持批量处理

## 技术方案讨论

### 待讨论的技术选择

1. **PDF 解析库选择**

   - 选项A：PyPDF2 - 轻量级，适合简单文本提取
   - 选项B：pdfplumber - 更强大的表格和布局识别
   - 选项C：pymupdf (fitz) - 速度快，支持复杂布局
   - 选项D：pdfminer - 底层控制能力强
2. **页眉识别策略**

   - 方案A：基于页面位置的文本识别
   - 方案B：基于字体大小和样式的识别
   - 方案C：基于关键词匹配（"权利要求书"、"Claims"等）
   - 方案D：结合多种特征的综合识别
3. **章节分割方法**

   - 方案A：基于页眉变化检测章节边界
   - 方案B：基于内容结构分析
   - 方案C：基于页码范围提取
4. **输出格式优化**

   - 格式A：纯文本 (.txt)
   - 格式B：Markdown (.md) - 保留结构信息
   - 格式C：结构化 JSON - 便于程序处理

### 推荐技术选择

**轻量化解决方案组合：**

- **包管理器**：uv - 快速、现代化的 Python 包管理
- **PDF解析库**：pdfplumber - 轻量级，专注文本提取，忽略图片处理
- **页眉识别**：关键词匹配 + 位置验证的组合方案
- **章节分割**：基于页眉变化检测
- **输出格式**：Markdown格式，保留结构的同时便于LLM读取
- **命令行接口**：Click框架，提供友好的CLI体验
- **项目结构**：src布局，模块化设计

## 实现计划

### 第一阶段：项目架构搭建

1. 使用 uv 创建项目结构和依赖管理
2. 建立 src 布局的模块化架构
3. 配置 pyproject.toml 和命令行入口点

### 第二阶段：核心解析模块

1. 实现轻量化PDF文本提取功能
2. 实现页眉检测和章节识别算法
3. 实现"权利要求书"内容提取逻辑

### 第三阶段：命令行工具

1. 使用 Click 框架实现 CLI 接口
2. 支持单文件和批量处理模式
3. 提供详细的进度反馈和错误处理

### 第四阶段：测试和优化

1. 使用现有专利PDF文件进行测试
2. 优化文本识别准确性
3. 性能调优和异常处理完善

## 任务清单

### 项目搭建

- [ ] 使用 uv 初始化项目依赖管理
- [ ] 创建 src/tdt_parser 模块结构
- [ ] 配置 pyproject.toml 文件
- [ ] 建立 CLI 入口点配置

### 核心功能开发

- [ ] 实现 PDF 文本提取模块
- [ ] 实现页眉识别算法
- [ ] 实现权利要求书章节定位
- [ ] 实现内容提取和格式化
- [ ] 实现输出文件管理

### 命令行工具

- [ ] 设计 CLI 参数和选项
- [ ] 实现单文件处理命令
- [ ] 实现批量处理命令
- [ ] 添加进度显示和日志功能

### 测试和文档

- [ ] 编写单元测试
- [ ] 使用实际专利文件测试
- [ ] 编写使用文档
- [ ] 性能基准测试

## 执行记录

### 2025-01-07 项目架构设计

- [X] 创建了 docs 文件夹
- [X] 建立了 PDF 解析讨论文档
- [X] 根据用户反馈优化了 Prompt 和文档结构
- [X] 明确了轻量化技术方案：
  - 使用 uv 进行包管理
  - 采用 src 布局和模块化设计
  - 专注文本提取，忽略图片处理
  - 提供命令行工具接口

### 用户反馈要点

1. **Prompt 优化**：使用结构化、详细的 Prompt，明确指定使用 Claude-3.5-Sonnet
2. **任务清单格式**：使用 `- [ ]` 和 `- [x]` 格式便于 Markdown 渲染
3. **轻量化要求**：专注文本和数学公式，不处理图片内容
4. **工具链选择**：必须使用 uv 管理依赖，最终交付命令行工具

### 下一步计划

- [X] 等待用户确认技术方案细节
- [X] 开始实现项目架构搭建
- [X] 逐步完成任务清单中的各项工作

### 2025-01-07 项目实现完成

- [X] 使用 uv 搭建项目结构和依赖管理
- [X] 实现核心PDF解析模块 (parser.py)
- [X] 实现权利要求书提取模块 (extractor.py)
- [X] 实现工具函数模块 (file_utils.py, text_utils.py)
- [X] 开发命令行工具接口 (cli.py)
- [X] 测试并验证功能正常

### 功能验证结果

使用测试文件 `CN202210107337_FullTextImage.pdf` 进行验证：

**测试结果：**

- ✅ 成功解析PDF文件（38页）
- ✅ 正确识别权利要求书章节（第2-3页）
- ✅ 成功提取10个权利要求条目
- ✅ 生成结构化Markdown输出（2735字符）
- ✅ 包含完整的TdT酶突变位点信息

**命令行工具测试：**

```bash
# 查看PDF结构信息
uv run tdt-extract info Patents/CN202210107337_FullTextImage.pdf

# 提取权利要求书内容
uv run tdt-extract extract Patents/CN202210107337_FullTextImage.pdf -o output -f markdown

# 批量处理（待测试）
uv run tdt-extract batch Patents/ -o output -f markdown
```

### 技术实现亮点

1. **轻量化设计** - 专注文本提取，忽略图片处理
2. **灵活的识别算法** - 支持页眉和内容中的关键词识别
3. **结构化输出** - Markdown格式便于LLM理解和人类阅读
4. **智能格式化** - 自动分离权利要求编号，添加结构化标记
5. **友好的CLI** - 支持单文件和批量处理
6. **完善的日志** - 详细的处理过程信息

### 格式化优化成果

经过用户反馈优化后，输出文件具有以下特点：

- ✅ **权利要求分离** - 每个权利要求独立标题和内容
- ✅ **依据关系标记** - 从属权利要求用"**依据：**"标记
- ✅ **特征突出显示** - 技术特征用"**特征：**"标记
- ✅ **参数列表化** - 技术参数(X1,X2等)用列表格式
- ✅ **页面清晰分隔** - 不同页面用分隔线和页标识
- ✅ **便于内容对比** - 结构化输出便于验证提取准确性
